<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Generador de propuestas Odoo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1020;
      --card-bg: #141a2a;
      --card-border: #262c3f;
      --accent: #ff5b5b;
      --accent-soft: #ffb347;
      --accent-2: #32d0ff;
      --text: #f5f7ff;
      --muted: #8a92b5;
      --error: #ff6b81;
      --radius-lg: 18px;
      --radius-md: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #171f3b, #050814 55%);
      color: var(--text);
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0)
        ),
        #050814;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
      padding: 24px 24px 18px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 1.4rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header h1 span.badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(50, 208, 255, 0.1);
      color: var(--accent-2);
      border: 1px solid rgba(50, 208, 255, 0.4);
    }

    header p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .pill {
      font-size: 0.78rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      background: rgba(255, 255, 255, 0.02);
      color: var(--muted);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 20px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      padding: 18px 18px 16px;
    }

    .card h2 {
      font-size: 1rem;
      margin: 0 0 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card h2 span.dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(255, 91, 91, 0.25);
    }

    .field {
      margin-bottom: 12px;
    }

    .field label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .field label span.label-main {
      color: #d8dcff;
    }

    select,
    input[type="text"],
    textarea {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.07);
      padding: 8px 10px;
      background: rgba(4, 8, 24, 0.9);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
    }

    select:focus,
    input[type="text"]:focus,
    textarea:focus {
      border-color: rgba(50, 208, 255, 0.9);
      box-shadow: 0 0 0 1px rgba(50, 208, 255, 0.4);
      background: rgba(4, 8, 24, 0.95);
    }

    input[type="text"].error {
      border-color: var(--error);
      box-shadow: 0 0 0 1px rgba(255, 107, 129, 0.4);
    }

    .error-text {
      color: var(--error);
      font-size: 0.78rem;
      margin-top: 2px;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .links-grid {
      display: grid;
      gap: 8px;
    }

    .link-item {
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.01);
      border: 1px dashed rgba(255, 255, 255, 0.08);
    }

    .link-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .badge-small {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 8px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      transition: transform 0.05s ease-out, box-shadow 0.1s ease-out,
        background 0.15s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff7a7a, #ffb347);
      color: #1b1220;
      box-shadow: 0 12px 22px rgba(255, 122, 122, 0.35);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(255, 122, 122, 0.4);
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.04);
    }

    .hint {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .tabs {
      display: inline-flex;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.03);
      padding: 2px;
      margin-bottom: 8px;
    }

    .tab {
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tab.active {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }

    .output {
      position: relative;
      margin-top: 8px;
    }

    .output textarea {
      width: 100%;
      min-height: 320px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      line-height: 1.4;
      background: #050712;
      border-radius: var(--radius-md);
    }

    .preview-box {
      background: #ffffff;
      color: #111827;
      border-radius: var(--radius-md);
      min-height: 320px;
      padding: 0;
      overflow: auto;
    }

    .hidden {
      display: none;
    }

    .status-line {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    .status-line span.positive {
      color: #4ade80;
    }

    .status-line span.negative {
      color: var(--error);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div>
        <h1>
          Generador de propuestas Odoo
          <span class="badge">beta</span>
        </h1>
        <p>
          Pega 1‚Äì3 URLs de cotizaciones, elige un estilo y genera el HTML del
          correo listo para tu comercial.
        </p>
        <div class="pill-row">
          <span class="pill">Validaci√≥n b√°sica de URL</span>
          <span class="pill">3 estilos de HTML</span>
          <span class="pill">Vista c√≥digo &amp; previa</span>
        </div>
      </div>
    </header>

    <main>
      <!-- PANEL IZQUIERDO: CONTROLES -->
      <section class="card">
        <h2><span class="dot"></span> Configuraci√≥n de la propuesta</h2>

        <div class="field">
          <label>
            <span class="label-main">N√∫mero de propuestas</span>
            <span>1‚Äì3 enlaces</span>
          </label>
          <select id="linkCount">
            <option value="1">1 link</option>
            <option value="2">2 links</option>
            <option value="3" selected>3 links</option>
          </select>
        </div>

        <div class="field">
          <label>
            <span class="label-main">Estilo de dise√±o</span>
            <span>3 variantes</span>
          </label>
          <select id="styleSelect">
            <option value="style1">Estilo 1 ‚Äì tarjetas coloridas</option>
            <option value="style2">Estilo 2 ‚Äì dise√±o compacto</option>
            <option value="style3">Estilo 3 ‚Äì minimalista</option>
          </select>
        </div>

        <div class="field">
          <label>
            <span class="label-main">URLs de cotizaciones</span>
            <span>se validan antes de generar</span>
          </label>
          <div class="links-grid" id="linksContainer">
            <!-- Se crean din√°micamente -->
          </div>
          <div class="hint">
            M√°s adelante puedes ajustar el patr√≥n de validaci√≥n de la URL
            (por ejemplo, que empiece por
            <code>https://odoo.com/my/orders/...</code>).
          </div>
        </div>

        <div class="field">
          <label>
            <span class="label-main">Comentarios adicionales</span>
            <span>opcional</span>
          </label>
          <textarea
            id="extraComments"
            placeholder="Ej: Esta propuesta incluye soporte prioritario y formaci√≥n inicial para vuestro equipo..."
          ></textarea>
        </div>

        <div class="controls-row">
          <button class="btn btn-primary" id="generateBtn">
            <span>‚ö°</span> Generar HTML
          </button>
          <button class="btn btn-ghost" id="fillDummyBtn">
            Rellenar datos de ejemplo
          </button>
        </div>
        <div class="hint">
          *Los importes se leen en tiempo real desde cada URL de Odoo mediante
          <code>fetchQuotationData()</code>. Si tu navegador bloquea la petici√≥n
          (CORS), ejecuta la herramienta desde un entorno con acceso permitido.
        </div>
      </section>

      <!-- PANEL DERECHO: SALIDA -->
      <section class="card">
        <h2><span class="dot"></span> Resultado del correo</h2>

        <div class="tabs">
          <button class="tab active" data-view="code">
            <span>üßæ</span> C√≥digo HTML
          </button>
          <button class="tab" data-view="preview">
            <span>üëÄ</span> Vista previa
          </button>
        </div>

        <div class="output">
          <textarea id="htmlOutput" spellcheck="false"></textarea>
          <div id="previewOutput" class="preview-box hidden"></div>
        </div>

        <div class="status-line">
          <span id="statusText">Listo para generar.</span>
          <span id="statusRight"></span>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Cambia esto por el patr√≥n real cuando lo tengas:
    const VALID_URL_REGEX =
      /^https:\/\/(?:www\.)?odoo\.com\/my\/orders\/\d+(?:\?.*)?$/i;

    const linkCountSelect = document.getElementById("linkCount");
    const linksContainer = document.getElementById("linksContainer");
    const generateBtn = document.getElementById("generateBtn");
    const fillDummyBtn = document.getElementById("fillDummyBtn");
    const styleSelect = document.getElementById("styleSelect");
    const extraComments = document.getElementById("extraComments");
    const htmlOutput = document.getElementById("htmlOutput");
    const previewOutput = document.getElementById("previewOutput");
    const statusText = document.getElementById("statusText");
    const statusRight = document.getElementById("statusRight");

    const tabs = document.querySelectorAll(".tab");
    const STYLE_LABELS = {
      style1: "Estilo 1",
      style2: "Estilo 2",
      style3: "Estilo 3",
    };

    function getStyleLabel(value) {
      return STYLE_LABELS[value] || value;
    }

    function cleanText(value) {
      return (value || "")
        .replace(/\uFEFF/g, "")
        .replace(/\u00a0|\u202f/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function escapeHtml(value) {
      return (value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function parseLocalizedNumber(value) {
      const text = cleanText(value);
      if (!text) return null;
      const sanitized = text.replace(/[^\d.,-]/g, "");
      if (!sanitized) return null;
      const lastComma = sanitized.lastIndexOf(",");
      const lastDot = sanitized.lastIndexOf(".");
      let normalized = sanitized;
      if (lastComma > lastDot) {
        normalized = sanitized.replace(/\./g, "").replace(/,/g, ".");
      } else {
        normalized = sanitized.replace(/,/g, "");
      }
      const parsed = Number(normalized);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function extractMonetaryParts(span) {
      if (!span) {
        return { text: "", value: null, symbol: "" };
      }
      const numericText = cleanText(span.textContent);
      const parentText = cleanText(span.parentNode ? span.parentNode.textContent : numericText);
      const symbolFromParent = parentText
        .replace(numericText, "")
        .replace(/[0-9.,\-\s]/g, "")
        .trim();
      const siblingSymbol = cleanText(span.nextSibling ? span.nextSibling.textContent : "").replace(
        /[0-9.,\-\s]/g,
        ""
      );
      const symbol = symbolFromParent || siblingSymbol || "";
      const value = parseLocalizedNumber(numericText);
      return {
        text: parentText || [numericText, symbol].filter(Boolean).join(" "),
        value,
        symbol,
      };
    }

    function formatCurrencyValue(value, symbol) {
      if (typeof value !== "number" || Number.isNaN(value)) return "";
      const formatted = value.toLocaleString("es-ES", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
      return symbol ? `${formatted} ${symbol}` : formatted;
    }

    function findTableValue(table, label) {
      if (!table) return "";
      const rows = Array.from(table.querySelectorAll("tr"));
      const match = rows.find((row) => {
        const header = cleanText(row.querySelector("th")?.textContent);
        return header.toLowerCase().startsWith(label.toLowerCase());
      });
      if (!match) return "";
      const cell =
        match.querySelector("td span") ||
        match.querySelector("td em") ||
        match.querySelector("td");
      return cleanText(cell?.textContent);
    }

    function getSectionText(doc, headingText) {
      const sections = Array.from(doc.querySelectorAll("section"));
      const target = headingText.toLowerCase();
      for (const section of sections) {
        const title = cleanText(section.querySelector("h4")?.textContent || "");
        if (title.toLowerCase().includes(target)) {
          const paragraphs = Array.from(section.querySelectorAll("p"));
          const content = paragraphs
            .map((p) => cleanText(p.textContent))
            .filter(Boolean)
            .join(" ");
          return content || cleanText(section.textContent);
        }
      }
      return "";
    }

    function deriveDurationText(planLabel, expirationDate) {
      const plan = cleanText(planLabel);
      const match = plan.match(/(\d+)\s*(a√±o|a√±os|year|years|mes|meses|month|months)/i);
      if (match) {
        const value = parseInt(match[1], 10);
        const unit = match[2].toLowerCase();
        if (Number.isFinite(value) && value > 0) {
          if (unit.startsWith("a√±o") || unit.startsWith("year")) {
            const months = value * 12;
            return `${value} ${value === 1 ? "a√±o" : "a√±os"} (${months} meses)`;
          }
          return `${value} ${value === 1 ? "mes" : "meses"}`;
        }
      }
      if (expirationDate) {
        return `V√°lido hasta ${expirationDate}`;
      }
      return plan;
    }

    function createLinkInputs() {
      linksContainer.innerHTML = "";
      const count = parseInt(linkCountSelect.value, 10);

      for (let i = 1; i <= 3; i++) {
        const div = document.createElement("div");
        div.className = "link-item";
        div.dataset.index = i;

        const header = document.createElement("div");
        header.className = "link-item-header";

        const label = document.createElement("span");
        label.textContent = `Link ${i}`;
        const badge = document.createElement("span");
        badge.className = "badge-small";
        if (i === 1) badge.textContent = "Plan Esencial";
        else if (i === 2) badge.textContent = "Plan Equilibrado";
        else badge.textContent = "Plan Premium";

        header.appendChild(label);
        header.appendChild(badge);

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "https://www.odoo.com/my/orders/....";
        input.id = `url${i}`;

        const error = document.createElement("div");
        error.className = "error-text";
        error.id = `url${i}Error`;
        error.textContent = "";
        error.style.display = "none";

        div.appendChild(header);
        div.appendChild(input);
        div.appendChild(error);

        if (i > count) {
          div.style.display = "none";
        }

        linksContainer.appendChild(div);
      }
    }

    linkCountSelect.addEventListener("change", createLinkInputs);

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");
        const view = tab.dataset.view;

        if (view === "code") {
          htmlOutput.classList.remove("hidden");
          previewOutput.classList.add("hidden");
        } else {
          htmlOutput.classList.add("hidden");
          previewOutput.classList.remove("hidden");
        }
      });
    });

    function setStatus(message, type = "neutral") {
      statusText.textContent = message;
      statusRight.textContent = "";
      statusText.classList.remove("positive", "negative");
      if (type === "success") statusText.classList.add("positive");
      if (type === "error") statusText.classList.add("negative");
    }

    function validateUrls() {
      const count = parseInt(linkCountSelect.value, 10);
      const urls = [];
      let allValid = true;

      for (let i = 1; i <= count; i++) {
        const input = document.getElementById(`url${i}`);
        const errorEl = document.getElementById(`url${i}Error`);
        const value = (input.value || "").trim();

        input.classList.remove("error");
        errorEl.style.display = "none";
        errorEl.textContent = "";

        if (!value) {
          errorEl.textContent = "Este campo es obligatorio.";
          errorEl.style.display = "block";
          input.classList.add("error");
          allValid = false;
          continue;
        }

        if (!VALID_URL_REGEX.test(value)) {
          errorEl.textContent =
            "La URL no cumple el patr√≥n esperado. Revisa el enlace.";
          errorEl.style.display = "block";
          input.classList.add("error");
          allValid = false;
          continue;
        }

        urls.push(value);
      }

      return { allValid, urls };
    }

    async function fetchQuotationData(url, index) {
      let response;
      try {
        response = await fetch(url, {
          mode: "cors",
          credentials: "omit",
          cache: "no-store",
        });
      } catch (networkError) {
        throw new Error(
          "No pudimos conectar con Odoo. Comprueba tu red o un posible bloqueo CORS."
        );
      }

      if (!response.ok) {
        throw new Error(
          `La URL devolvi√≥ el estado ${response.status}. Verifica que el enlace siga activo.`
        );
      }

      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      const subscriptionTable = doc
        .querySelector("#sale_info_title")
        ?.closest("div")
        ?.querySelector("table");

      const planLabel = findTableValue(subscriptionTable, "Plan");
      const orderName = findTableValue(subscriptionTable, "Order");
      const orderDate = findTableValue(subscriptionTable, "Date");
      const expirationDate = findTableValue(subscriptionTable, "Expiration");
      const reference = findTableValue(subscriptionTable, "Reference");

      const totalSpan = doc.querySelector(
        'table[name="sale_order_totals_table"] tr.o_total span.oe_currency_value'
      );
      const totalMonetary = extractMonetaryParts(totalSpan);
      const fallbackCurrency = totalMonetary.symbol || "‚Ç¨";

      const productRows = Array.from(
        doc.querySelectorAll('#sales_order_table tbody tr[name="tr_product"]')
      );

      if (!productRows.length) {
        throw new Error(
          "No se encontraron l√≠neas de productos dentro de la cotizaci√≥n."
        );
      }

      const lineItems = productRows.map((row) => {
        const name = cleanText(
          row.querySelector('[name="td_product_name"]')?.textContent
        );

        const quantityWrapper = row.querySelector('[name="td_product_quantity"]');
        const quantitySpans = quantityWrapper
          ? Array.from(quantityWrapper.querySelectorAll("span"))
          : [];
        const quantityValue = parseLocalizedNumber(quantitySpans[0]?.textContent);
        const quantityUnit = cleanText(quantitySpans[1]?.textContent || "");
        const quantityDisplay = quantitySpans.length
          ? [cleanText(quantitySpans[0]?.textContent), quantityUnit]
              .filter(Boolean)
              .join(" ")
          : "";

        const unitPriceInfo = extractMonetaryParts(
          row.querySelector('[name="td_product_priceunit"] .oe_currency_value')
        );
        const amountInfo = extractMonetaryParts(
          row.querySelector('[name="td_product_subtotal"] .oe_currency_value')
        );

        const currencySymbol =
          amountInfo.symbol || unitPriceInfo.symbol || fallbackCurrency;

        return {
          name,
          quantityValue,
          quantityDisplay,
          unitPriceValue: unitPriceInfo.value,
          unitPriceText: unitPriceInfo.text,
          amountValue: amountInfo.value ?? 0,
          amountText: amountInfo.text,
          currencySymbol,
        };
      });

      const positiveLines = lineItems.filter((line) => (line.amountValue || 0) > 0);
      const discountLines = lineItems.filter((line) => (line.amountValue || 0) < 0);
      const mainLine = positiveLines[0] || lineItems[0];

      const totalSavingsValue = discountLines.reduce((acc, line) => {
        const value = Math.abs(line.amountValue || 0);
        return acc + value;
      }, 0);

      const totalSavingsText = totalSavingsValue
        ? formatCurrencyValue(totalSavingsValue, fallbackCurrency)
        : "";

      const paymentTerms = getSectionText(doc, "payment terms");

      return {
        title: planLabel || orderName || `Plan ${index}`,
        subtitle: reference || orderName || "",
        duration: deriveDurationText(planLabel, expirationDate),
        orderName,
        orderDate,
        expirationDate,
        totalAmountText: totalMonetary.text,
        totalAmountValue: totalMonetary.value,
        currencySymbol: fallbackCurrency,
        pricePerLicenseText: mainLine?.unitPriceText || "",
        quantityText: mainLine?.quantityDisplay || "",
        mainProduct: mainLine?.name || "",
        paymentTerms,
        totalSavingsText,
        totalSavingsValue: totalSavingsValue || null,
        savingsBreakdown: discountLines.map((line) => ({
          label: line.name,
          amountText:
            formatCurrencyValue(Math.abs(line.amountValue || 0), fallbackCurrency) ||
            line.amountText,
        })),
        summaryLine: mainLine
          ? [mainLine.name, mainLine.quantityDisplay].filter(Boolean).join(" ¬∑ ")
          : "",
        ctaUrl: url,
      };
    }

    function buildEmailBody(style, plans, comments) {
      const disclaimer = `
        <p style="font-size:12px;color:#4b5563;margin-top:16px;">
          <strong>Fuente:</strong> Los importes se importan directamente desde las cotizaciones enlazadas en Odoo. Revisa siempre la informaci√≥n original antes de enviar el correo.<br/><br/>
          <strong>Ahorros detectados:</strong> Las l√≠neas con importe negativo se interpretan como descuentos y se listan en cada plan.
        </p>
      `;

      const commentsHtml = comments
        ? `<div style="margin-top:18px;padding:12px 14px;border-radius:10px;background:#fef9c3;color:#713f12;font-size:13px;">
            <strong>Nota adicional:</strong><br/>
            ${escapeHtml(comments).replace(/\n/g, "<br/>")}
          </div>`
        : "";

      const cardsHtml = plans
        .map((p, idx) => {
          const safeTitle = escapeHtml(p.title || "Plan sin nombre");
          const safeSubtitle = escapeHtml(p.subtitle || "");
          const safeAmount = escapeHtml(p.totalAmountText || "Importe no disponible");
          const safeDuration = escapeHtml(p.duration || "");
          const safePrice = escapeHtml(p.pricePerLicenseText || "");
          const safeQuantity = escapeHtml(p.quantityText || "");
          const safeSummary = escapeHtml(p.summaryLine || "");
          const safePayment = escapeHtml(p.paymentTerms || "");
          const safeSavings = escapeHtml(p.totalSavingsText || "");
          const safeExpiration = escapeHtml(p.expirationDate || "");

          const isBest = idx === 1 && plans.length > 1;
          const savingsList = (p.savingsBreakdown || [])
            .map((item) => {
              const label = escapeHtml(item.label || "");
              const amount = escapeHtml(item.amountText || "");
              if (!label || !amount) return "";
              return `<li style="margin:0;padding:0;line-height:1.4;">${label}: ${amount}</li>`;
            })
            .filter(Boolean)
            .join("");

          if (style === "style2") {
            return `
              <tr>
                <td style="padding:12px 10px;border-bottom:1px solid #e5e7eb;">
                  <div style="font-size:13px;font-weight:600;color:#111827;margin-bottom:2px;">
                    ${safeTitle}
                    ${
                      isBest
                        ? '<span style="font-size:11px;padding:2px 6px;margin-left:6px;border-radius:999px;background:#f97316;color:#fff;">M√°s elegido</span>'
                        : ""
                    }
                  </div>
                  ${
                    p.subtitle
                      ? `<div style="font-size:11px;color:#6b7280;margin-bottom:4px;">${safeSubtitle}</div>`
                      : ""
                  }
                  <div style="font-size:18px;font-weight:700;color:#111827;">${safeAmount}</div>
                  ${
                    p.duration
                      ? `<div style="font-size:12px;color:#4b5563;margin-top:2px;">${safeDuration}</div>`
                      : ""
                  }
                </td>
                <td style="padding:12px 10px;border-bottom:1px solid #e5e7eb;font-size:12px;color:#4b5563;">
                  ${
                    p.summaryLine
                      ? `<div><strong>Oferta principal:</strong> ${safeSummary}</div>`
                      : ""
                  }
                  ${
                    p.pricePerLicenseText
                      ? `<div><strong>Precio licencia:</strong> ${safePrice}${
                          p.quantityText ? ` ¬∑ ${safeQuantity}` : ""
                        }</div>`
                      : ""
                  }
                  ${
                    p.paymentTerms
                      ? `<div><strong>Condiciones pago:</strong> ${safePayment}</div>`
                      : ""
                  }
                  ${
                    p.totalSavingsText
                      ? `<div><strong>Ahorro detectado:</strong> ${safeSavings}</div>`
                      : ""
                  }
                  ${
                    savingsList
                      ? `<ul style="padding-left:16px;margin:4px 0 0;color:#4b5563;">${savingsList}</ul>`
                      : ""
                  }
                </td>
                <td style="padding:12px 10px;border-bottom:1px solid #e5e7eb;font-size:12px;color:#4b5563;">
                  ${
                    p.expirationDate
                      ? `<div><strong>Vigencia:</strong> Hasta ${safeExpiration}</div>`
                      : ""
                  }
                  <div style="margin-top:6px;">
                    <a href="${escapeHtml(
                      p.ctaUrl
                    )}" style="display:inline-block;padding:7px 14px;border-radius:999px;background:#111827;color:#f9fafb;font-size:12px;text-decoration:none;font-weight:600;">Comenzar ahora</a>
                  </div>
                </td>
              </tr>
            `;
          }

          const palette =
            style === "style1"
              ? ["#06b6d4", "#f97316", "#16a34a"]
              : ["#0f172a", "#111827", "#020617"];
          const bg = palette[idx] || palette[0];
          const fg = style === "style1" ? "#0b1220" : "#f9fafb";
          const pillBg =
            style === "style1"
              ? "rgba(255,255,255,0.2)"
              : "rgba(15,23,42,1)";
          const cardBg =
            style === "style1"
              ? "#f9fafb"
              : idx === 1
              ? "#020617"
              : "#0b1120";

          return `
            <td style="padding:0 8px;">
              <table width="100%" cellpadding="0" cellspacing="0" style="border-radius:18px;overflow:hidden;background:${cardBg};border:1px solid #e5e7eb;">
                <tr>
                  <td style="padding:14px 16px;background:${bg};color:${fg};text-align:center;">
                    ${
                      isBest
                        ? '<div style="font-size:11px;text-transform:uppercase;letter-spacing:.08em;padding:2px 10px;border-radius:999px;background:' +
                          pillBg +
                          ';display:inline-block;margin-bottom:4px;">‚≠ê M√°s elegido</div>'
                        : ""
                    }
                    <div style="font-size:14px;font-weight:600;margin-bottom:2px;">${safeTitle}</div>
                    ${
                      p.subtitle
                        ? `<div style="font-size:11px;opacity:.65;margin-bottom:4px;">${safeSubtitle}</div>`
                        : ""
                    }
                    <div style="font-size:11px;opacity:.9;">TOTAL CONTRATO</div>
                    <div style="font-size:20px;font-weight:700;margin-top:2px;">${safeAmount}</div>
                    ${
                      p.duration
                        ? `<div style="font-size:12px;margin-top:4px;opacity:.9;">${safeDuration}</div>`
                        : ""
                    }
                    ${
                      p.pricePerLicenseText
                        ? `<div style="font-size:11px;margin-top:2px;opacity:.9;">Precio por licencia: ${safePrice}${
                            p.quantityText ? ` ¬∑ ${safeQuantity}` : ""
                          }</div>`
                        : ""
                    }
                  </td>
                </tr>
                <tr>
                  <td style="padding:12px 14px;font-size:12px;color:${
                    style === "style1" ? "#111827" : "#e5e7eb"
                  };background:${style === "style1" ? "#ffffff" : "#0b1120"};">
                    ${
                      p.summaryLine
                        ? `<div style="margin-bottom:6px;">
                      <span style="font-weight:600;">üì¶ Oferta incluida</span><br/>
                      ${safeSummary}
                    </div>`
                        : ""
                    }
                    ${
                      p.paymentTerms
                        ? `<div style="margin-bottom:6px;">
                      <span style="font-weight:600;">üíé Condiciones de pago</span><br/>
                      ${safePayment}
                    </div>`
                        : ""
                    }
                    ${
                      p.totalSavingsText
                        ? `<div style="margin-bottom:6px;">
                      <span style="font-weight:600;">üí∞ Ahorro detectado</span><br/>
                      ${safeSavings}
                      ${
                        savingsList
                          ? `<div style="margin-top:4px;"><ul style="padding-left:16px;margin:0;color:${
                              style === "style1" ? "#6b7280" : "#9ca3af"
                            };">${savingsList}</ul></div>`
                          : ""
                      }
                    </div>`
                        : ""
                    }
                    ${
                      p.expirationDate
                        ? `<div style="margin-bottom:10px;">
                      <span style="font-weight:600;">üóì Vigencia</span><br/>
                      Hasta ${safeExpiration}
                    </div>`
                        : ""
                    }
                    <div style="text-align:center;">
                      <a href="${escapeHtml(
                        p.ctaUrl
                      )}" style="display:inline-block;padding:8px 16px;border-radius:999px;background:${
            style === "style1" ? "#4f46e5" : "#111827"
          };color:#f9fafb;font-weight:600;font-size:12px;text-decoration:none;">
                        Comenzar ahora
                      </a>
                    </div>
                  </td>
                </tr>
              </table>
            </td>
          `;
        })
        .join("");

      if (style === "style2") {
        return `
          <table width="100%" cellpadding="0" cellspacing="0" style="max-width:780px;margin:0 auto;background:#f9fafb;border-radius:18px;border:1px solid #e5e7eb;">
            <tr>
              <td style="padding:18px 18px 14px;">
                <div style="font-size:16px;font-weight:600;color:#111827;">Comparativa de opciones de suscripci√≥n</div>
                <div style="font-size:13px;color:#4b5563;margin-top:4px;">
                  Los importes provienen directamente de tus cotizaciones en Odoo para que puedas compartirlos con tus clientes de forma clara.
                </div>
                ${commentsHtml}
              </td>
            </tr>
            <tr>
              <td>
                <table width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;">
                  ${cardsHtml}
                </table>
              </td>
            </tr>
            <tr>
              <td style="padding:0 18px 16px;">
                ${disclaimer}
              </td>
            </tr>
          </table>
        `;
      }

      const bgOuter = style === "style1" ? "#e5e7eb" : "#020617";
      const bgInner = style === "style1" ? "#f9fafb" : "#020617";
      const mainText = style === "style1" ? "#111827" : "#e5e7eb";
      const subText = style === "style1" ? "#4b5563" : "#9ca3af";

      return `
        <table width="100%" cellpadding="0" cellspacing="0" style="max-width:820px;margin:0 auto;background:${bgOuter};padding:18px;border-radius:20px;">
          <tr>
            <td>
              <table width="100%" cellpadding="0" cellspacing="0" style="background:${bgInner};border-radius:16px;padding:18px;">
                <tr>
                  <td style="text-align:left;padding-bottom:12px;">
                    <div style="font-size:16px;font-weight:600;color:${mainText};">Resumen de tu propuesta Odoo</div>
                    <div style="font-size:13px;color:${subText};margin-top:4px;">
                      A continuaci√≥n encontrar√°s la comparativa de las cotizaciones importadas directamente desde Odoo para agilizar tu comunicaci√≥n comercial.
                    </div>
                    ${commentsHtml}
                  </td>
                </tr>
                <tr>
                  <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                      <tr>
                        ${cardsHtml}
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td style="padding-top:8px;">
                    ${disclaimer}
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      `;
    }

    function buildFullHtml(bodyHtml) {
      return `
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Propuesta Odoo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body style="margin:0;padding:16px;background:#e5e7eb;">
  ${bodyHtml}
</body>
</html>`;
    }

    async function handleGenerate() {
      setStatus("Validando enlaces...", "neutral");
      const { allValid, urls } = validateUrls();
      if (!allValid) {
        setStatus("Hay errores en los enlaces. Rev√≠salos antes de continuar.", "error");
        return;
      }

      try {
        const plans = [];
        for (let i = 0; i < urls.length; i++) {
          setStatus(`Leyendo cotizaci√≥n ${i + 1} de ${urls.length}...`, "neutral");
          const data = await fetchQuotationData(urls[i], i + 1);
          plans.push(data);
        }

        if (!plans.length) {
          setStatus("No se pudo obtener ninguna cotizaci√≥n.", "error");
          return;
        }

        const style = styleSelect.value;
        const comments = extraComments.value.trim();
        const bodyHtml = buildEmailBody(style, plans, comments);
        const fullHtml = buildFullHtml(bodyHtml);

        htmlOutput.value = fullHtml;
        previewOutput.innerHTML = bodyHtml;

        setStatus("HTML generado correctamente.", "success");
        statusRight.textContent = `${plans.length} plan(es) ¬∑ ${getStyleLabel(style)}`;
      } catch (err) {
        console.error(err);
        setStatus(
          err?.message ||
            "Ocurri√≥ un error generando el HTML. Revisa la consola del navegador.",
          "error"
        );
      }
    }

    function fillDummyData() {
      const count = parseInt(linkCountSelect.value, 10);
      const sampleUrl =
        "https://www.odoo.com/my/orders/6970352?access_token=55c22618-2c2b-4ac5-a510-4c8adfa4abce";
      for (let i = 1; i <= count; i++) {
        const input = document.getElementById(`url${i}`);
        if (input) {
          input.value = sampleUrl;
        }
      }
      setStatus(
        "Enlaces de ejemplo rellenados. Sustit√∫yelos por tus URLs reales antes de enviar el correo.",
        "neutral"
      );
    }

    generateBtn.addEventListener("click", handleGenerate);
    fillDummyBtn.addEventListener("click", fillDummyData);

    // Inicializar
    createLinkInputs();
    setStatus("Listo para generar.");

  </script>
</body>
</html>
